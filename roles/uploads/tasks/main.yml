---
- name: Create new user for www uploads
  become: yes
  shell: useradd -m www_uploads && mkdir -p /home/www_uploads/.ssh/
  ignore_errors: yes

- name: Check if authorized_keys exists
  become: yes
  stat: path=/home/www_uploads/.ssh/authorized_keys
  register: p

- name: Generate authorized_keys with pubkey
  vars:
    pubkey: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          30333135663930336234323266336464316662326630623662336536396464663130623335613437
          6233653139323736646131653838646263663536363631640a396638366130666238303631346262
          32323463663033643930666566316131333462643138646530393935343033353663653336626163
          6430363038646231360a623439306530353366643836343565663938313135393433353138633130
          64356430346332656465663461343433383232376436336334656664633535653438373136393638
          35636435613230636632373338623539373333316563646532303736663463646662353536393630
          38313835363935636362626231376436623461646465623437323430643537613737316534646138
          61636233663036393830633636653138663639623864616566633962333730656264306235666537
          37363961636538656235323334386561336430393534356335366236343833313232613831393239
          33326334333364343039653532346337613234386366366563353831333335376139326332326534
          62623866613933396632366239633265663063616464363263386162636236303139333064343331
          62656166386336326361623431386431346466653331336430336364663630646461646561386638
          35646235386162356563343065663963396139393464366562623964303339373037333864363936
          39636333346664343265333532623362376536643563623532666238363438346635393936666132
          61353531653566393461396538656531653365653334643432303664363162333464346436366231
          31343931613934613265653962656232633161666562623831306537363838613533613861326131
          66393334343232353564343762326239373832396338353436323930626137303161373032363530
          63633937333962333332383935646464663734343763633633356163356134303134363863343736
          38653336666535653238353631396365613536653166396539366339626536643435343631643566
          65323662616161636433643366623338373232306164333063386132323130643333316234356261
          34653162616663323165643030663530366463376363353862393932663765643436613565646435
          35313931633639623361656539623163646331383432643230326330326464356130626139376564
          33306161323035393164633566633532323866633933343139623534383435623966376162376234
          33623962616464323536346663333938323232386337383662313935353839353338323039336566
          3336
  become: yes
  shell: echo "{{ pubkey }}" > /home/www_uploads/.ssh/authorized_keys
  when: p.stat.exists == False

- name: Create www dir with www_uploads user access
  become: yes
  shell: mkdir -p /var/www/html/ && setfacl -m u:www_uploads:rwx /var/www/html
